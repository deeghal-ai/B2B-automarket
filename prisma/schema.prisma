// prisma/schema.prisma
// B2B Auto Marketplace Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  role      Role     @default(BUYER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller       Seller?
  cart         Cart?
  orders       Order[]
  negotiations Negotiation[] @relation("BuyerNegotiations")
}

enum Role {
  BUYER
  SELLER
  ADMIN
}

// ============================================
// SELLER
// ============================================

model Seller {
  id          String   @id @default(cuid())
  userId      String   @unique
  companyName String
  country     String
  city        String
  phone       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicles       Vehicle[]
  columnMappings ColumnMapping[]
  negotiations   Negotiation[]
}

// ============================================
// VEHICLE (Core Entity)
// ============================================

model Vehicle {
  id String @id @default(cuid())

  // Ownership
  sellerId String
  seller   Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Identification
  vin            String  @unique
  registrationNo String?

  // ===== GROUPING FIELDS (indexed for performance) =====
  make      String // Toyota, Honda, BMW
  model     String // Camry, Accord, X5
  variant   String? // LE, SE, Sport, xDrive
  year      Int
  color     String
  condition Condition
  bodyType  BodyType

  // Specifications
  regionalSpecs   String? // GCC, American, European, Japanese
  fuelType        FuelType
  transmission    Transmission
  drivetrain      Drivetrain
  engineSize      Float? // in liters (e.g., 2.5)
  cylinders       Int?
  horsepower      Int?
  seatingCapacity Int?
  doors           Int?
  mileage         Int // in kilometers

  // Location
  city    String
  country String

  // Content
  description String?
  features    String[] // Array of feature strings

  // Pricing
  price    Decimal?      @db.Decimal(12, 2) // Nullable for RFQ vehicles
  currency String        @default("USD")
  incoterm String?       // FOB or CIF (required when price is set)
  status   VehicleStatus @default(DRAFT)

  // External Links
  inspectionReportLink String? // URL to vehicle inspection report

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  images           VehicleImage[]
  cartItems        CartItem[]
  orderItems       OrderItem[]
  inspectionReport InspectionReport?
  negotiationItems NegotiationItem[]

  // ===== INDEXES FOR GROUPING QUERIES =====
  @@index([sellerId, status])
  @@index([make, model, year])
  @@index([make, model, variant, year, color, condition])
  @@index([status, make])
  @@index([status, country])
}

model VehicleImage {
  id        String   @id @default(cuid())
  vehicleId String
  url       String
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

// ============================================
// ENUMS
// ============================================

enum Condition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum BodyType {
  SEDAN
  SUV
  HATCHBACK
  COUPE
  CONVERTIBLE
  WAGON
  VAN
  TRUCK
  PICKUP
  OTHER
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
  PLUGIN_HYBRID
  OTHER
}

enum Transmission {
  AUTOMATIC
  MANUAL
  CVT
  DCT
  OTHER
}

enum Drivetrain {
  FWD
  RWD
  AWD
  FOUR_WD
}

enum VehicleStatus {
  DRAFT
  PUBLISHED
  SOLD
  RESERVED
}

// ============================================
// CART (Buyer's Shopping Cart)
// ============================================

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  vehicleId String
  addedAt   DateTime @default(now())

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([cartId, vehicleId])
  @@index([cartId])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id          String      @id @default(cuid())
  buyerId     String
  status      OrderStatus @default(PENDING)
  totalAmount Decimal     @db.Decimal(14, 2)
  currency    String      @default("USD")
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  buyer User        @relation(fields: [buyerId], references: [id])
  items OrderItem[]

  @@index([buyerId])
  @@index([status])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  vehicleId String
  price     Decimal @db.Decimal(12, 2)
  currency  String  @default("USD")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@index([orderId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

// ============================================
// NEGOTIATIONS (Deal Rooms)
// ============================================

model Negotiation {
  id             String            @id @default(cuid())
  buyerId        String
  sellerId       String
  status         NegotiationStatus @default(DRAFT)
  incoterm       String            @default("FOB")
  depositPercent Int               @default(10)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  buyer    User                 @relation("BuyerNegotiations", fields: [buyerId], references: [id])
  seller   Seller               @relation(fields: [sellerId], references: [id])
  items    NegotiationItem[]
  messages NegotiationMessage[]

  @@index([buyerId, sellerId]) // Composite index for buyer-seller pair lookup
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model NegotiationItem {
  id            String  @id @default(cuid())
  negotiationId String
  vehicleId     String
  systemPrice   Decimal @db.Decimal(12, 2)
  offerPrice    Decimal @db.Decimal(12, 2)

  negotiation Negotiation @relation(fields: [negotiationId], references: [id], onDelete: Cascade)
  vehicle     Vehicle     @relation(fields: [vehicleId], references: [id])

  @@index([negotiationId])
}

model NegotiationMessage {
  id            String   @id @default(cuid())
  negotiationId String
  senderId      String
  senderRole    String
  content       String
  createdAt     DateTime @default(now())

  negotiation Negotiation @relation(fields: [negotiationId], references: [id], onDelete: Cascade)

  @@index([negotiationId])
}

enum NegotiationStatus {
  DRAFT
  BUYER_FINALIZED
  SELLER_APPROVED
  CANCELLED
}

// ============================================
// COLUMN MAPPING (For Excel Uploads)
// ============================================

model ColumnMapping {
  id        String   @id @default(cuid())
  sellerId  String
  name      String
  mapping   Json
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
}

// ============================================
// INSPECTION REPORT (Scraped from external source)
// ============================================

model InspectionReport {
  id        String @id @default(cuid())
  vehicleId String @unique
  sourceUrl String

  // Extracted data
  overallGrade   String  // E, D, C, B, A
  inspectionDate String?

  // Category scores (X/Y format)
  accidentScore String? // e.g., "9/70"
  floodScore    String? // e.g., "7/27"
  fireScore     String? // e.g., "0/23"
  deepScore     String? // e.g., "13/42"

  // Conclusions
  isAccidentCar Boolean?
  isFloodCar    Boolean?
  isFireCar     Boolean?

  // Metadata
  rawResponse Json?    // Store full OpenAI response for debugging
  scrapedAt   DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}


model MasterVehicleData {
  id        String   @id @default(cuid())
  make      String
  model     String
  variant   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([make, model, variant])
  @@index([make])
  @@index([make, model])
}
